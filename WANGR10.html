<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WANGR10 — Firestore 同步版</title>
<style>
:root{--bg:#0f0f10;--card:#141414;--muted:#bdbdbd;--accent:#4fc3f7;--danger:#ff3b3b}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:#fff;font-family:"Microsoft JhengHei",Arial}
.topbar{position:fixed;left:0;right:0;top:0;background:#111;padding:12px 16px;display:flex;gap:12px;align-items:center;z-index:50}
.title{font-weight:800;color:#ffd54f;margin-right:8px}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.container{max-width:1200px;margin:0 auto;padding:20px;padding-top:90px;display:grid;grid-template-columns:1fr 1fr;gap:18px}
.add-box{grid-column:1/-1;background:var(--card);padding:12px;border-radius:10px;border:1px solid #222;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.boss-card{background:#121212;padding:16px;border-radius:12px;border:1px solid #222;min-height:180px}
.h2{color:var(--accent);font-size:18px;margin:0 0 8px 0}
.info{color:var(--muted);font-size:14px;line-height:1.7}
.btn{padding:8px 10px;border-radius:8px;border:none;background:#2b2b2b;color:#fff;cursor:pointer;font-weight:700}
.btn.primary{background:#ff9800;color:#111}
.btn.green{background:#4caf50}
.btn.red{background:#d9534f}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input{background:#0b0b0b;border:1px solid #222;padding:6px;border-radius:6px;color:#fff}
.small{padding:6px 8px;border-radius:6px}
.future{color:var(--muted);margin-top:8px;font-size:13px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#222;padding:10px 14px;border-radius:8px;border:1px solid #333;display:none}
.notice{font-size:13px;color:var(--muted);margin-left:8px}
.col-full{grid-column:1/-1}
@media(max-width:900px){.container{grid-template-columns:1fr;padding:12px}}
</style>
</head>
<body>

<div class="topbar">
  <div class="title">WANGR10 — Firestore 同步版</div>
  <div id="topNext">下一個：載入中… <span id="topCd" style="margin-left:12px;color:var(--danger);font-weight:800"></span></div>
  <div class="controls">
    <button class="btn" id="signinBtn">貼上 Firebase Config</button>
    <button class="btn" id="downloadBtn">下載 HTML</button>
  </div>
</div>

<div class="container" id="container">
  <div class="add-box col-full">
    <label class="notice">Firebase 未設定？按「貼上 Firebase Config」貼上整段 config JSON（或直接在程式中填入）。</label>
    <input id="filter" class="input" placeholder="搜尋名稱" style="width:200px"/>
    <button class="btn" id="refreshBtn">重整</button>
  </div>
  <!-- cards will be inserted here -->
  <div class="col-full future-legend" style="color:var(--muted);font-size:13px">資料來源：Firestore 集合 <strong>/bosses</strong></div>
</div>

<div id="toast" class="toast"></div>

<!-- firebase (compat to keep code shorter) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
/* WANGR10 Firestore 同步版
User must paste firebaseConfig JSON (from Firebase Console -> Project Overview -> Add web app).
We accept a JSON object string pasted by user.
*/
let db = null;
let app = null;
let unsubscribe = null;
let bossesCache = {}; // id -> doc

const toastEl = document.getElementById('toast');
function toast(msg, ms=1600){ toastEl.textContent=msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', ms); }

// download current HTML
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const blob=new Blob([document.documentElement.outerHTML], {type:'text/html;charset=utf-8'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='WANGR10_v10.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('已下載 HTML');
});

// show prompt to paste firebase config
document.getElementById('signinBtn').addEventListener('click', async ()=>{
  const s = prompt("請貼上你的 firebaseConfig JSON（範例：{apiKey:'', authDomain:'', projectId:'...'}）\n或按取消以手動在程式中填入。");
  if(!s) return;
  try{
    const cfg = JSON.parse(s.replace(/(\r\n|\n)/g,''));
    initFirebase(cfg);
    toast('Firebase 初始化完成');
  }catch(e){ alert('JSON 解析錯誤，請確保貼上的內容是 firebaseConfig 的 JSON'); }
});

// refresh button
document.getElementById('refreshBtn').addEventListener('click', ()=> { if(db) subscribe(); else toast('請先貼上 Firebase Config'); });

// create a card element
function createCard(id, data){
  const card = document.createElement('div'); card.className='boss-card'; card.dataset.id=id;
  const h = document.createElement('div'); h.className='h2'; h.textContent = data.name || id;
  const info = document.createElement('div'); info.className='info';
  const last = document.createElement('div'); last.id = 'last-'+id; last.textContent = '上次擊殺：' + (data.lastkill?fmtTime(data.lastkill):'--:--');
  const next = document.createElement('div'); next.id = 'next-'+id; next.innerHTML = '下一次重生： <span style="color:var(--danger);font-weight:900">' + calcNext(data) + '</span>';
  const cd = document.createElement('div'); cd.id = 'cd-'+id; cd.textContent = '倒數：--:--';
  info.appendChild(last); info.appendChild(next); info.appendChild(cd);

  const btns = document.createElement('div'); btns.className='row';
  const killBtn = document.createElement('button'); killBtn.className='btn green'; killBtn.textContent='已擊殺';
  killBtn.onclick = ()=> doKilled(id);
  btns.appendChild(killBtn);

  ['+1','-1','+5','-5'].forEach(t=>{
    const b=document.createElement('button'); b.className='btn'; b.textContent=t; b.onclick=()=> adjustNext(id, parseInt(t));
    btns.appendChild(b);
  });

  // killtime controls
  const ktRow = document.createElement('div'); ktRow.className='row'; ktRow.style.marginTop='8px';
  const ktLabel = document.createElement('div'); ktLabel.className='notice'; ktLabel.textContent='擊殺耗時：';
  const ktVal = document.createElement('div'); ktVal.id='kt-'+id; ktVal.className='notice'; ktVal.textContent = (data.killtime||0) + ' 分';
  const ktMinus = document.createElement('button'); ktMinus.className='btn small'; ktMinus.textContent='-1'; ktMinus.onclick=()=> changeKilltime(id, -1);
  const ktPlus = document.createElement('button'); ktPlus.className='btn small'; ktPlus.textContent='+1'; ktPlus.onclick=()=> changeKilltime(id, +1);
  ktRow.appendChild(ktLabel); ktRow.appendChild(ktVal); ktRow.appendChild(ktMinus); ktRow.appendChild(ktPlus);

  // manual set
  const manual = document.createElement('div'); manual.className='row'; manual.style.marginTop='8px';
  const nowBtn = document.createElement('button'); nowBtn.className='btn small'; nowBtn.textContent='現在時間';
  const hour = document.createElement('input'); hour.type='number'; hour.className='input'; hour.placeholder='時'; hour.style.width='70px';
  const minute = document.createElement('input'); minute.type='number'; minute.className='input'; minute.placeholder='分'; minute.style.width='70px';
  const apply = document.createElement('button'); apply.className='btn'; apply.textContent='套用';
  nowBtn.onclick = ()=>{ const d=new Date(); hour.value=d.getHours(); minute.value=d.getMinutes(); };
  apply.onclick = ()=> applyManual(id, hour.value, minute.value);
  manual.appendChild(nowBtn); manual.appendChild(hour); manual.appendChild(minute); manual.appendChild(apply);

  // future list
  const future = document.createElement('div'); future.id='future-'+id; future.className='future'; future.textContent = '未來：' + calcFutureList(data);

  card.appendChild(h); card.appendChild(info); card.appendChild(btns); card.appendChild(ktRow); card.appendChild(manual); card.appendChild(future);
  return card;
}

function fmtTime(ms){
  if(!ms) return '--:--';
  const d=new Date(ms);
  return d.toLocaleTimeString('zh-TW',{hour12:false});
}

function calcNext(data){
  // next = lastkill + respawn*60000  (per confirmed logic)
  const last = data.lastkill || 0;
  if(!last) return '--:--';
  const next = last + (data.respawn||0)*60000;
  return fmtTime(next);
}

function calcFutureList(data){
  const next = (data.lastkill||0) + (data.respawn||0)*60000;
  if(!next) return '--';
  const arr=[];
  // Mode B: each future i adds respawn*i and killtime*i
  for(let i=1;i<=3;i++){
    const t = next + (data.respawn||0)*i*60000 + (data.killtime||0)*i*60000;
    arr.push(fmtTime(t));
  }
  return arr.join('、');
}

function renderAll(){
  const cont = document.getElementById('container');
  // remove existing cards (except add-box and footer)
  document.querySelectorAll('.boss-card').forEach(e=>e.remove());
  Object.keys(bossesCache).sort().forEach(id=>{
    const data = bossesCache[id];
    const card = createCard(id, data);
    // insert before footer (last element with class future-legend)
    const footer = document.querySelector('.future-legend');
    footer.parentNode.insertBefore(card, footer);
  });
}

// firestore helpers
function initFirebase(config){
  if(app) { toast('已初始化 Firebase'); return; }
  app = firebase.initializeApp(config);
  db = firebase.firestore();
  subscribe();
}

function subscribe(){
  if(!db){ toast('Firebase 未初始化'); return; }
  if(unsubscribe) unsubscribe();
  const col = db.collection('bosses');
  unsubscribe = col.onSnapshot(snapshot=>{
    snapshot.docChanges().forEach(ch=>{
      const id = ch.doc.id;
      const data = ch.doc.data();
      if(ch.type === 'removed'){ delete bossesCache[id]; }
      else bossesCache[id] = data;
    });
    renderAll();
    updateTopNext();
  }, err=>{
    console.error(err); toast('Firestore 訂閱錯誤');
  });
}

function updateTopNext(){
  // find nearest next
  let soon = null;
  Object.values(bossesCache).forEach(d=>{
    const last = d.lastkill || 0;
    const next = last + (d.respawn||0)*60000;
    if(!soon || next < soon.time) soon={name:d.name,time:next};
  });
  if(soon){
    const diff = Math.max(0, soon.time - Date.now());
    document.getElementById('topNext').innerHTML = '下一個：' + soon.name + ' <span id="topCd" style="color:var(--danger);font-weight:900">' + Math.floor(diff/60000) + '分 ' + Math.floor((diff%60000)/1000) + '秒</span>';
  }
}

// actions
function doKilled(id){
  const doc = db.collection('bosses').doc(id);
  const now = Date.now();
  // per confirmed: last = now (no kt), next = last + respawn (no kt)
  doc.update({ lastkill: now }).then(()=>{ toast('已紀錄 '+id+' 擊殺'); }).catch(e=>{ alert('寫入失敗：'+e); });
}

function adjustNext(id, minutes){
  // shift stored next (which is last+respawn) by minutes => equivalently change last by +minutes
  const doc = db.collection('bosses').doc(id);
  const data = bossesCache[id];
  if(!data) return;
  const shift = minutes*60000;
  const newLast = (data.lastkill||0) + shift;
  doc.update({ lastkill: newLast }).then(()=> toast('已調整 ' + id) ).catch(e=>alert('錯誤：'+e));
}

function changeKilltime(id, delta){
  const doc = db.collection('bosses').doc(id);
  const data = bossesCache[id];
  if(!data) return;
  const newKt = Math.max(0, (data.killtime||0) + delta);
  doc.update({ killtime: newKt }).then(()=> toast('已修改擊殺耗時') ).catch(e=>alert('錯誤：'+e));
}

function applyManual(id, h, m){
  const hh = parseInt(h,10), mm = parseInt(m,10);
  if(isNaN(hh) || isNaN(mm)) { alert('請輸入時與分或按現在時間'); return; }
  const now = new Date();
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
  // if time is in future, assume it was earlier today
  if(d.getTime() > Date.now()) d.setDate(d.getDate()-1);
  const doc = db.collection('bosses').doc(id);
  // per confirmed: last = specified time (no killtime)
  doc.update({ lastkill: d.getTime() }).then(()=> toast('已套用時間') ).catch(e=>alert('錯誤：'+e));
}

// helper search filter
document.getElementById('filter').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  document.querySelectorAll('.boss-card').forEach(c=>{
    const id=c.dataset.id; const name = (bossesCache[id] && bossesCache[id].name)||'';
    c.style.display = (!q || name.toLowerCase().includes(q)) ? '' : 'none';
  });
});

// start (if user already embedded config in file, try to auto-init)
// optional: you can paste defaultConfig below as JSON to auto-init
const defaultConfig = const firebaseConfig = {
  apiKey: "AIzaSyDs9i1UKuvUohyE2dYQYk6nSBXHrvTvzEM",
  authDomain: "wangr-sync2.firebaseapp.com",
  projectId: "wangr-sync2",
  storageBucket: "wangr-sync2.firebasestorage.app",
  messagingSenderId: "1010873667172",
  appId: "1:1010873667172:web:ba68012141814fed241971"
};; // e.g. {"apiKey":"...","authDomain":"...","projectId":"wangr-sync2",...}
if(defaultConfig) initFirebase(defaultConfig);

</script>
</body>
</html>
