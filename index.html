<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  query
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ========= Firebase ========= */

const firebaseConfig = {
  apiKey: "AIzaSyAgV1fpP2XRS5fhgg4h0clp9AEJqAJtypo",
  authDomain: "wangr-sync.firebaseapp.com",
  projectId: "wangr-sync",
  storageBucket: "wangr-sync.firebasestorage.app",
  messagingSenderId: "178110502200",
  appId: "1:178110502200:web:adb5dc30cf34c5f0dc9dcd",
  measurementId: "G-ZN1H4KHEJR"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ========= æœ¬åœ°ç‹€æ…‹ ========= */

// é—œæ³¨çš„çŽ‹ï¼ˆå­˜åœ¨ç€è¦½å™¨ï¼‰
const pinnedBosses = new Set(
  JSON.parse(localStorage.getItem("pinnedBosses") || "[]")
);

/* ========= DOM ========= */

const bossList = document.getElementById("bossList");

/* ========= å·¥å…· ========= */

function savePinned() {
  localStorage.setItem(
    "pinnedBosses",
    JSON.stringify([...pinnedBosses])
  );
}

function isPinned(boss) {
  return pinnedBosses.has(boss);
}

/* ========= UI Render ========= */

function renderBossList(bosses) {
  bossList.innerHTML = "";

  // ðŸ”¥ æŽ’åºè¦å‰‡ï¼š
  // 1. é—œæ³¨çš„åœ¨æœ€ä¸Šé¢
  // 2. å…¶é¤˜ä¾ detectedAt æ–°åˆ°èˆŠ
  bosses.sort((a, b) => {
    const ap = isPinned(a.boss) ? 1 : 0;
    const bp = isPinned(b.boss) ? 1 : 0;
    if (ap !== bp) return bp - ap;
    return b.detectedAt - a.detectedAt;
  });

  bosses.forEach(b => {
    const div = document.createElement("div");
    div.style.border = "1px solid #444";
    div.style.padding = "10px";
    div.style.marginBottom = "10px";
    div.style.background = isPinned(b.boss)
      ? "#1b2a4a"
      : "#111";

    const checked = isPinned(b.boss) ? "checked" : "";

    div.innerHTML = `
      <label style="float:right; cursor:pointer">
        <input type="checkbox" ${checked} />
        é—œæ³¨
      </label>
      <b>${b.boss}</b><br>
      åœ°åœ–ï¼š${b.map || "æœªçŸ¥"}<br>
      ä¸Šæ¬¡å‡ºç¾ï¼š${new Date(b.detectedAt).toLocaleString()}
    `;

    // å‹¾é¸äº‹ä»¶
    div.querySelector("input").addEventListener("change", e => {
      if (e.target.checked) {
        pinnedBosses.add(b.boss);
      } else {
        pinnedBosses.delete(b.boss);
      }
      savePinned();
      renderBossList(bosses);
    });

    bossList.appendChild(div);
  });
}

/* ========= Firestore å³æ™‚ç›£è½ ========= */

const q = query(collection(db, "bossEvents"));

onSnapshot(q, snap => {
  const bosses = [];
  snap.forEach(doc => bosses.push(doc.data()));
  renderBossList(bosses);
});

</script>
