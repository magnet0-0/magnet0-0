<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>ç‹é‡ç”Ÿå³æ™‚çœ‹æ¿</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { background:#0b1020; color:#fff; font-family:system-ui; padding:20px }
.card { border:1px solid #444; padding:10px; margin-bottom:10px; background:#111 }
.pin { background:#1b2a4a }
.warn { box-shadow:0 0 12px #ffd36a }
.danger { box-shadow:0 0 14px #ff6b6b }
</style>
</head>
<body>

<h2>ğŸ”¥ ç‹é‡ç”Ÿå³æ™‚çœ‹æ¿ï¼ˆå³æ™‚å€’æ•¸ï¼‰</h2>
<div id="bossList"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgV1fpP2XRS5fhgg4h0clp9AEJqAJtypo",
  authDomain: "wangr-sync.firebaseapp.com",
  projectId: "wangr-sync",
  storageBucket: "wangr-sync.firebasestorage.app",
  messagingSenderId: "178110502200",
  appId: "1:178110502200:web:adb5dc30cf34c5f0dc9dcd",
  measurementId: "G-ZN1H4KHEJR"
};

const RESPAWN_TABLE = {
  "æ°´ç²¾éˆç‹": { min: 60, max: 90 },
  "å·´æ‹‰å¡æ–¯": { min: 120, max: 180 },
  "æ­»äº¡é¨å£«": { min: 90, max: 120 },
  "æ­»éˆå›ç‹": { min: 90, max: 120 },
  "é»‘é•·è€…": { min: 120, max: 150 },
  "å¤ä»£å·¨äºº": { min: 180, max: 240 },
  "ä¸æ­»é³¥": { min: 240, max: 300 },
  "å†°ä¹‹å¥³ç‹": { min: 180, max: 240 }
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const bossList = document.getElementById("bossList");
const pinnedBosses = new Set(JSON.parse(localStorage.getItem("pinnedBosses")||"[]"));
let latestBosses = [];

function savePinned(){
  localStorage.setItem("pinnedBosses", JSON.stringify([...pinnedBosses]));
}

function formatMS(ms){
  if(ms<=0) return "00:00:00";
  const s=Math.floor(ms/1000);
  const h=Math.floor(s/3600);
  const m=Math.floor((s%3600)/60);
  const ss=s%60;
  return [h,m,ss].map(v=>String(v).padStart(2,"0")).join(":");
}

function calcRespawn(boss, detectedAt){
  const r=RESPAWN_TABLE[boss];
  if(!r) return null;
  return {
    min: detectedAt + r.min*60000,
    max: detectedAt + r.max*60000
  };
}

function renderBossList(bosses){
  bossList.innerHTML="";
  const now=Date.now();

  bosses.sort((a,b)=>{
    const ap=pinnedBosses.has(a.boss)?1:0;
    const bp=pinnedBosses.has(b.boss)?1:0;
    if(ap!==bp) return bp-ap;
    return b.detectedAt-b.detectedAt;
  });

  bosses.forEach(b=>{
    const resp=calcRespawn(b.boss,b.detectedAt);
    let cls="card";
    let html="<i>æœªçŸ¥é‡ç”Ÿæ™‚é–“</i>";

    if(resp){
      const untilMin=resp.min-now;
      const untilMax=resp.max-now;
      if(untilMin>0){
        html=`æœ€æ—©å€’æ•¸ <b>${formatMS(untilMin)}</b><br>æœ€æ™šå€’æ•¸ ${formatMS(untilMax)}`;
      }else if(untilMax>0){
        html=`âš ï¸ å·²é€²å…¥å¯èƒ½åˆ·æ–°å€é–“<br>æœ€æ™šå€’æ•¸ ${formatMS(untilMax)}`;
        cls+=" warn";
      }else{
        html="ğŸ”¥ æ¥µå¯èƒ½å·²åˆ·æ–°";
        cls+=" danger";
      }
    }

    if(pinnedBosses.has(b.boss)) cls+=" pin";

    const div=document.createElement("div");
    div.className=cls;
    div.innerHTML=`
      <label style="float:right">
        <input type="checkbox" ${pinnedBosses.has(b.boss)?"checked":""}> é—œæ³¨
      </label>
      <b>${b.boss}</b><br>
      åœ°åœ–ï¼š${b.map||"æœªçŸ¥"}<br>
      ä¸Šæ¬¡å‡ºç¾ï¼š${new Date(b.detectedAt).toLocaleString()}<br>
      ${html}
    `;

    div.querySelector("input").addEventListener("change",e=>{
      if(e.target.checked) pinnedBosses.add(b.boss);
      else pinnedBosses.delete(b.boss);
      savePinned();
      renderBossList(latestBosses);
    });

    bossList.appendChild(div);
  });
}

onSnapshot(collection(db,"bossEvents"),snap=>{
  latestBosses=[];
  snap.forEach(doc=>latestBosses.push(doc.data()));
  renderBossList(latestBosses);
});

setInterval(()=>renderBossList(latestBosses),1000);
</script>

</body>
</html>
