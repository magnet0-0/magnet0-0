<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WANGR13 v8.9 FINAL</title>
<style>
:root{
  --bg:#050509;--panel:#101015;--card:#14141a;
  --text:#eee;--muted:#aaa;--danger:#ff5252;
  --accent:#7c4dff;--accent2:#448aff;--ok:#6cff6c;--warn:#ffb84d;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
font-family:"Microsoft JhengHei","Noto Sans TC",Arial}
.topbar{position:fixed;top:0;left:0;right:0;z-index:999;
background:linear-gradient(180deg,#0a0a0f,#050509);padding:14px 18px}
.top-row{display:flex;align-items:center;gap:20px}
.top-left{flex:1}
.top-label{font-size:13px;color:#ccc}
.top-name{font-size:28px;font-weight:900;margin-top:2px}
.top-cd{font-size:48px;font-weight:900;color:var(--danger);margin-top:6px}
.top-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.slider{width:160px}
.btn{background:#2a2a2f;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
.btn.small{padding:6px 10px;font-size:13px}
.btn.orange{background:#ffb200;color:#111;font-weight:800}
.btn.green{background:#2e7d32}
.btn.red{background:#c62828}
.progress-line{height:2px;margin-top:12px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.container{max-width:1100px;margin:170px auto 24px;padding:0 16px}
.panel{background:linear-gradient(180deg,#1b1230,#0f0f18);
border-radius:16px;padding:14px;margin-bottom:16px;border:1px solid rgba(255,255,255,.08)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input{background:#0b0b0c;border:1px solid #222;color:#fff;border-radius:8px;padding:6px 8px}
.input.small{width:70px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.boss-card{background:linear-gradient(180deg,#16161f,#0e0e14);
border-radius:16px;padding:14px;position:relative;border:1px solid rgba(255,215,128,.35)}
.boss-title{font-size:22px;font-weight:900;color:#ffe082}
.info{font-size:13px;margin-top:4px;color:#e0e0ff}
.system-line{font-weight:800;margin-top:4px}
.next-time{color:#ffab91;font-weight:900}
.countdown{font-size:18px;font-weight:900;color:#fff}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.smallbtn{background:linear-gradient(180deg,#3949ab,#1a237e);
border-radius:8px;padding:6px 10px;color:#fff;border:0;cursor:pointer;font-size:12px;font-weight:700}
.future{margin-top:8px;color:#bbb;font-size:12px}
.lastmod{margin-top:4px;color:#aaa;font-size:12px}
.manual{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}

/* === éˆ´éºï¼šç‹å¡å…§ã€è³‡è¨Šå€å³å´ï¼ˆéå€’æ•¸å€ï¼‰ === */
.boss-card{ position:relative; }
.notifybtn{
  position:absolute;
  right:16px;
  top:64px;            /* aligns with the info block under the title */
  width:28px;
  height:28px;
  border-radius:50%;
  background:#2a2a2f;
  color:#ffd54f;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:14px;
}
.notifybtn.off{ opacity:0.35; }

</style>
</head>
<body>

<div id="soundTestBar" style="position:fixed;bottom:10px;right:10px;z-index:9999;">
  <button id="soundTestBtn" style="padding:8px 12px;font-size:14px;">ğŸ”Š </button>
</div>


<div class="topbar">
  <div class="top-row">
    <div class="top-left">
      <div class="top-label">ä¸‹ä¸€å€‹ï¼š</div>
      <div id="topName" class="top-name">â€”</div>
      <div id="topCd" class="top-cd">--:--:--</div>
    </div>
    <div class="top-right">
      <span style="font-size:13px">éŸ³é‡</span>
      <input id="vol" class="slider" type="range" min="0" max="1" step="0.01" value="0.8"/>
      <button id="allowNotif" class="btn small">å…è¨±é€šçŸ¥ï¼‹å•Ÿç”¨éŸ³æ•ˆ</button>
      <button id="muteAll" class="btn small">é—œé–‰é€šçŸ¥/éŸ³æ•ˆ</button>
    </div>
  </div>
  <div class="progress-line"></div>
</div>

<div class="container">
  <div class="panel">
    <div class="row">
      åç¨±ï¼š
      <input id="newName" class="input" list="systemBossList"/>
      é‡ç”Ÿ(åˆ†)ï¼š
      <input id="newRespawn" class="input small" type="number" value="120"/>
      æ“Šæ®ºè€—æ™‚(åˆ†)ï¼š
      <input id="newKill" class="input small" type="number" value="3"/>
      <button id="addBtn" class="btn orange">æ–°å¢ç‹</button>
      <datalist id="systemBossList"></datalist>
    </div>
  </div>
  <div id="grid" class="grid"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
const bellState = {};

/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey:"AIzaSyDs9i1UKuvUohyE2dYQYk6nSBXHrvTvzEM",
  authDomain:"wangr-sync2.firebaseapp.com",
  projectId:"wangr-sync2"
});
const db=firebase.firestore();

const sysApp=firebase.initializeApp({
  apiKey:"AIzaSyAgV1fpP2XRS5fhgg4h0clp9AEJqAJtypo",
  authDomain:"wangr-sync.firebaseapp.com",
  projectId:"wangr-sync"
},"system");
const dbSystem=sysApp.firestore();

/* ================= System data ================= */
const systemBossList=[];
const systemSpawnMap={};

dbSystem.collection("boss_events").onSnapshot(snap=>{
  snap.forEach(doc=>{
    const d=doc.data();
    if(!d.boss) return;
    if(!systemBossList.includes(d.boss)) systemBossList.push(d.boss);
    if(!systemSpawnMap[d.boss]||d.spawnTime>systemSpawnMap[d.boss]){
      systemSpawnMap[d.boss]=d.spawnTime;
    }
  });
});

/* ===== Stable datalist ===== */
(function(){
  let last="";
  setInterval(()=>{
    const h=systemBossList.join("|");
    if(h===last) return;
    last=h;
    const dl=document.getElementById("systemBossList");
    dl.innerHTML="";
    systemBossList.forEach(n=>{
      const o=document.createElement("option");
      o.value=n;dl.appendChild(o);
    });
  },500);
})();

/* ================= Logic ================= */
const bosses={};

function pad(n){return String(n).padStart(2,"0")}
function fmt(ms){return new Date(ms).toLocaleTimeString("zh-TW",{hour12:false})}
function hms(ms){
  if(ms<=0) return "00:00:00";
  const s=Math.floor(ms/1000);
  return pad(Math.floor(s/3600))+":"+pad(Math.floor((s%3600)/60))+":"+pad(s%60);
}
function effectiveLastKill(doc,id){
  if(doc.lastkill_source==="manual") return doc.lastkill||0;
  return Math.max(doc.lastkill||0, systemSpawnMap[id]||0);
}
function computeNext(doc,id){
  const base=effectiveLastKill(doc,id);
  if(!base) return null;
  return base + (doc.respawn||0)*60000;
}
function computeFuture(doc,id){
  const base=effectiveLastKill(doc,id);
  if(!base) return [];
  const step=((doc.respawn||0)+(doc.killtime||0))*60000;
  const out=[];
  for(let i=1;i<=4;i++){
    out.push(fmt(base + (doc.respawn||0)*60000 + i*step));
  }
  return out;
}

/* ================= UI ================= */
function renderBoss(id,data){
  const card=document.createElement("div");
  card.className="boss-card";
  card.innerHTML=`
    <div class="boss-title">${id}</div>
<div class="notifybtn">ğŸ””</div>
    <div class="system-line">ç³»çµ±é‡ç”Ÿï¼š--</div>
    <div class="info last">ä¸Šæ¬¡æ“Šæ®ºï¼š--</div>
    <div class="info next">ä¸‹ä¸€æ¬¡é‡ç”Ÿï¼š--</div>
    <div class="countdown">--:--:--</div>
    <div class="controls">
      <button class="btn green kill">å·²æ“Šæ®º (å®Œæˆ)</button>
      <button class="smallbtn p1">+1</button>
      <button class="smallbtn m1">-1</button>
      <button class="smallbtn p5">+5</button>
      <button class="smallbtn m5">-5</button>
      <button class="btn red del">åˆªé™¤</button>
    </div>
    
<div class="info">
  åˆ·æ–°ç”¨æ™‚ï¼š
  <input class="input small respawn-edit" type="number" value="${data.respawn||0}"/> åˆ†
</div>
<div class="info">æ“Šæ®ºè€—æ™‚ï¼š <strong class="kt">${data.killtime||0}</strong> åˆ†
      <button class="smallbtn km">-1</button>
      <button class="smallbtn kp">+1</button>
    </div>
    <div class="manual">
      <input class="input small hh" placeholder="æ™‚"/>
      <input class="input small mm" placeholder="åˆ†"/>
      <input class="input small ss" placeholder="ç§’"/>
      <button class="btn apply">å¥—ç”¨</button>
    </div>
    <div class="future">æœªä¾†ï¼š--</div>
    <div class="lastmod">æœ€å¾Œä¿®æ”¹(LastKill)ï¼š--</div>
  `;
  document.getElementById("grid").appendChild(card);
  // apply bell state
  const bell = card.querySelector('.notifybtn');
  if(bellState[id] === false){
    bell.classList.add('off');
  }


  bosses[id]={...data,el:card};
  bindCard(id);
}

function adjustLastKill(id,deltaMin){
  const b=bosses[id];
  const base = effectiveLastKill(b,id) || Date.now();
  db.collection("bosses").doc(id).set({
    lastkill: base + deltaMin*60000,
    lastkill_source:"manual"
  },{merge:true});
}

function bindCard(id){
  const b=bosses[id];
  const el=b.el;

  el.querySelector(".kill").onclick=()=>{
    db.collection("bosses").doc(id).set({
      lastkill:Date.now(),
      lastkill_source:"manual"
    },{merge:true});
  };

  el.querySelector(".p1").onclick=()=>adjustLastKill(id,1);
  el.querySelector(".m1").onclick=()=>adjustLastKill(id,-1);
  el.querySelector(".p5").onclick=()=>adjustLastKill(id,5);
  el.querySelector(".m5").onclick=()=>adjustLastKill(id,-5);

  el.querySelector(".apply").onclick=()=>{
    const hh=parseInt(el.querySelector(".hh").value,10);
    const mm=parseInt(el.querySelector(".mm").value,10);
    const ss=parseInt(el.querySelector(".ss").value,10);
    if(isNaN(hh)||isNaN(mm)||isNaN(ss)) return;
    const now=new Date();
    const dt=new Date(now.getFullYear(),now.getMonth(),now.getDate(),hh,mm,ss,0);
    db.collection("bosses").doc(id).set({
      lastkill:dt.getTime(),
      lastkill_source:"manual"
    },{merge:true});
  };

  el.querySelector(".del").onclick=()=>{
    if(confirm("åˆªé™¤ "+id+" ?")){
      db.collection("bosses").doc(id).delete();
    }
  };

  el.querySelector(".kp").onclick=()=>{
    db.collection("bosses").doc(id).set({killtime:(b.killtime||0)+1},{merge:true});
  };
  el.querySelector(".km").onclick=()=>{
    db.collection("bosses").doc(id).set({killtime:Math.max(0,(b.killtime||0)-1)},{merge:true});
  };
}

/* ================= Add ================= */
document.getElementById("addBtn").onclick=()=>{
  const n=document.getElementById("newName").value.trim();
  if(!systemBossList.includes(n)){alert("è«‹å¾ä¸‹æ‹‰é¸æ“‡ç‹");return;}
  db.collection("bosses").doc(n).set({
    name:n,respawn:120,killtime:3,lastkill:0,lastkill_source:"system"
  },{merge:true});
};

/* ================= Listen ================= */
db.collection("bosses").onSnapshot(snap=>{
  document.getElementById("grid").innerHTML="";
  snap.forEach(doc=>{
    renderBoss(doc.id,doc.data());
  });
});

/* ================= Tick ================= */
setInterval(()=>{
  let top=null,topRem=1e18;
  Object.keys(bosses).forEach(id=>{
    const b=bosses[id];
    const el=b.el;
    const sys=systemSpawnMap[id];
    if(sys){
      el.querySelector(".system-line").textContent="ç³»çµ±é‡ç”Ÿï¼š"+fmt(sys);
    }
    let next=computeNext(b,id);
    if(next){
      let rem=next-Date.now();

      // === TIME FIX: overdue rolls forward by respawn ONLY (no system mix) ===
      if(rem <= 0){
        const step = (b.respawn||0)*60000;
        if(step>0){
          const missed = Math.floor((-rem)/step) + 1;
          next = next + missed*step;
          rem = next - Date.now();

          // === RESET ALERT FLAGS FOR NEW CYCLE ===
          b._a3 = false;
          b._a0 = false;
        }
      }

      el.querySelector(".next").innerHTML="ä¸‹ä¸€æ¬¡é‡ç”Ÿï¼š <span class='next-time'>"+fmt(next)+"</span>";
      el.querySelector(".countdown").textContent=hms(rem);
      const f=computeFuture(b,id);
      el.querySelector(".future").textContent="æœªä¾†ï¼š"+(f.length?" "+f.join(" ãƒ» "):"--");
      
      if(rem<topRem&&rem>0){topRem=rem;top=id;}

      b._a3=b._a3||false;
      b._a0=b._a0||false;
      const bell=el.querySelector('.notifybtn');

      if(window.__threeMinTrigger__ && window.__threeMinTrigger__(b, rem) && !b._a3){
        if(!bell.classList.contains('off')) playBeep(3);
        b._a3=true;
      }
      if(window.__respawnTrigger__ && window.__respawnTrigger__(b, rem) && !b._a0){
        b._a0 = true; // latch immediately to stop looping
        if(!bell.classList.contains('off')) playBeep(5);
      }

    }
    if(b.lastkill){
      el.querySelector(".last").textContent="ä¸Šæ¬¡æ“Šæ®ºï¼š"+fmt(b.lastkill);
      el.querySelector(".lastmod").textContent="æœ€å¾Œä¿®æ”¹(LastKill)ï¼š"+fmt(b.lastkill);
    }
    if(b.killtime!=null){
      el.querySelector(".kt").textContent=b.killtime;
    }
  });
  document.getElementById("topName").textContent=top||"â€”";
  document.getElementById("topCd").textContent=top?hms(topRem):"--:--:--";
},1000);

/* ================= Audio ================= */
let masterVol=0.8;
let audioCtx=null;
document.getElementById("vol").oninput=e=>masterVol=parseFloat(e.target.value);
document.getElementById("allowNotif").onclick=async()=>{
  if(Notification.permission!=="granted") await Notification.requestPermission();
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
};
document.getElementById("muteAll").onclick=()=>{
  masterVol=0;document.getElementById("vol").value=0;
};
</script>


<script>
document.addEventListener('click', e => {
  const bell = e.target.closest('.boss-card .notifybtn');
  if(!bell) return;
  const card = bell.closest('.boss-card');
  const id = card.querySelector('.boss-title').textContent;
  const off = bell.classList.toggle('off');
  bellState[id] = !off; // true=ON, false=OFF
});
</script>


<script>
// === PATCH: ç‹å¡å…§åˆ·æ–°ç”¨æ™‚å¯ç›´æ¥ä¿®æ”¹ ===
document.addEventListener('change', e => {
  const inp = e.target.closest('.respawn-edit');
  if(!inp) return;
  const card = inp.closest('.boss-card');
  if(!card) return;
  const nameEl = card.querySelector('.boss-title');
  if(!nameEl) return;
  const id = nameEl.textContent;
  const v = parseInt(inp.value, 10);
  if(isNaN(v) || v <= 0) return;
  firebase.firestore().collection("bosses").doc(id).set({
    respawn: v
  }, { merge:true });
});
</script>


<script>



<script>
/* === ALERT CYCLE RESET (FIX 3min + respawn SILENCE) === */
(function(){
  const _oldTick = window.__alertTick__;
  window.__alertTick__ = function(b, id, next){
    const key = Math.floor(next / 60000); // minute-level cycle key
    if(b._cycleKey !== key){
      b._cycleKey = key;
      b._a3 = false;
      b._a0 = false;
    }
  };
})();
</script>


<script>
/* === SOUND TEST + HARD UNLOCK === */
(function(){
  function ensureAudio(){
    if(!window.audioCtx){
      window.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    }
    if(window.audioCtx && window.audioCtx.state === "suspended"){
      window.audioCtx.resume();
    }
  }
  window.playBeep = function(times){
    ensureAudio();
    if(!window.audioCtx) return;
    for(let i=0;i<times;i++){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "square";
      o.frequency.value = 880;
      g.gain.value = 0.9;
      o.connect(g); g.connect(audioCtx.destination);
      const t = audioCtx.currentTime + i*0.25;
      o.start(t); o.stop(t+0.15);
    }
  };
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('soundTestBtn');
    if(btn){
      btn.onclick = ()=>{
        playBeep(2);
        console.log('ğŸ”Š sound test triggered');
      };
    }
  });
})();
</script>


<script>
/* === FIX RESPAWN EDGE (WHEN rem CROSSES 0) === */
(function(){
  // inject helper used in tick
  window.__checkRespawnEdge__ = function(b, rem){
    if(b._wasPositive === undefined) b._wasPositive = rem > 0;
    const crossed = b._wasPositive && rem <= 0;
    b._wasPositive = rem > 0;
    return crossed;
  };
})();
</script>


<script>
/* === SIMPLE RESPAWN TRIGGER (1s WINDOW) === */
(function(){
  window.__respawnTrigger__ = function(b, rem){
    const prev = b._prevRem;
    b._prevRem = rem;
    if(prev === undefined) return false;
    return prev > 1000 && rem <= 1000;
  };
})();
</script>


<script>
/* === FIX 3-MIN ONE-SHOT WINDOW === */
(function(){
  window.__threeMinTrigger__ = function(b, rem){
    const prev = b._prevRem3;
    b._prevRem3 = rem;
    if(prev === undefined) return false;
    // fire once when crossing 180s -> 179s
    return prev > 180000 && rem <= 180000;
  };
})();
</script>


/* === AUDIO FIX (NON-INTRUSIVE) === */
(function(){
  let inited = false;
  function ensureAudio(){
    if(!window.audioCtx){
      window.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    }
    if(window.audioCtx && window.audioCtx.state === "suspended"){
      window.audioCtx.resume();
    }
  }
  if(!inited){
    ["click","keydown","touchstart"].forEach(evt=>{
      window.addEventListener(evt, ensureAudio, {once:true});
    });
    inited = true;
  }
  window.playBeep = function(times){
    ensureAudio();
    if(!window.audioCtx) return;
    for(let i=0;i<times;i++){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "square";
      o.frequency.value = 880;
      g.gain.value = window.masterVol || 0.8;
      o.connect(g); g.connect(audioCtx.destination);
      const t = audioCtx.currentTime + i*0.25;
      o.start(t); o.stop(t+0.15);
    }
  };
})();
</script>

<script>
/* === HARD MUTE FIX === */
(function(){
  const origPlayBeep = window.playBeep;
  window.playBeep = function(times){
    if(typeof window.masterVol !== 'number') window.masterVol = 1;
    if(window.masterVol <= 0) return; // HARD MUTE
    return origPlayBeep ? origPlayBeep(times) : undefined;
  };
})();
</script>


<script>
/* === FINAL VOLUME BIND (TOP BAR ONLY) === */
document.addEventListener('DOMContentLoaded',()=>{
  const vol = document.getElementById('vol');
  if(!vol) return;
  // init
  const saved = Number(localStorage.getItem('masterVol'));
  window.masterVol = isNaN(saved)? (window.masterVol ?? 0.8): saved;
  vol.value = Math.round(window.masterVol*100);
  // bind
  vol.oninput = ()=>{
    window.masterVol = vol.value/100;
    localStorage.setItem('masterVol', window.masterVol);
  };
});
</script>

</body>
</html>
