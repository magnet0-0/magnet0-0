<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>打王時間系統 — C1 高級深色卡片版 v4</title>
<style>
:root{--bg:#0f0f10;--card:#1b1b1e;--muted:#bdbdbd;--accent:#4fc3f7;--accent2:#ffd54f;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:"Microsoft JhengHei",Arial;}
#topbar{position:fixed;top:0;left:0;right:0;background:#161616;padding:12px 18px;box-shadow:0 3px 20px #000;z-index:99;display:flex;align-items:center;gap:16px;}
#title{font-size:20px;color:var(--accent2);font-weight:700;}
#nextbox{display:flex;flex-direction:column;margin-left:6px;}
#nextbox .nextline{font-size:18px;font-weight:700;color:#fff;}
#controls{margin-left:auto;display:flex;gap:12px;align-items:center;}
.container{max-width:1200px;margin:0 auto;padding:18px;padding-top:100px;display:grid;grid-template-columns:repeat(2,1fr);gap:18px;}
@media(max-width:1000px){.container{grid-template-columns:1fr;padding:14px;padding-top:140px}}
.add-box{grid-column:1/-1;background:var(--card);padding:14px;border-radius:12px;border:1px solid #222;display:flex;align-items:center;gap:12px;}
.boss-card{background:#131313;border-radius:12px;padding:16px;border:1px solid #232323;box-shadow:0 8px 22px #0008;position:relative;min-height:220px;display:flex;flex-direction:column;justify-content:space-between;}
.card-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;}
.info-col{flex:1;min-width:0;}
.info-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;}
.info-top h2{margin:0;color:var(--accent);font-size:20px;}
.info-lines{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.6;}
.btns-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
.smallbtn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600;background:#2b2b2b;color:#fff;}
.btn-add{background:#ff9800;color:#111;}
.btn-kill{background:#4caf50;color:#fff;}
.btn-del{background:#d9534f;color:#fff;}
.controls{display:flex;align-items:center;gap:8px;}
.manual-inline{display:flex;gap:8px;align-items:center;margin-top:8px;}
.input-small{background:#0b0b0b;border:1px solid #222;color:#fff;padding:6px;border-radius:6px;}
.future{color:var(--muted);font-size:13px;margin-top:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.volume-control{display:flex;align-items:center;gap:8px;background:#101010;padding:6px;border-radius:8px;border:1px solid #222;}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#222;padding:10px 14px;border-radius:8px;border:1px solid #333;display:none;color:#fff;z-index:9999;}
.header-right{display:flex;gap:12px;align-items:center;}
</style>
</head>
<body>

<div id="topbar">
  <div id="title">打王時間系統 — C1 高級深色卡片版</div>
  <div id="nextbox">
    <div class="nextline">下一個： <span id="top-name">載入中...</span></div>
    <div class="meta">倒數：<span id="top-cd">--:--</span></div>
  </div>

  <div id="controls" class="header-right">
    <div class="volume-control"><span style="color:var(--muted);font-size:13px">音量</span><input id="volume" type="range" min="0" max="100" value="70" /></div>
    <button class="smallbtn" id="unlockBtn">允許通知 + 啟用音效</button>
    <button class="smallbtn" id="muteBtn">關閉通知/音效</button>
  </div>
</div>

<div class="container" id="container">
  <div class="add-box">
    <label style="color:var(--muted)">名稱：</label><input id="new-name" class="input-small" placeholder="例如：黑帝斯" />
    <label style="color:var(--muted)">重生(分鐘)：</label><input id="new-respawn" class="input-small" type="number" min="1" style="width:110px" />
    <button class="smallbtn btn-add" id="addBtn">新增王</button>
    <div style="margin-left:auto;color:var(--muted);font-size:13px;">固定順序（不會自動排序）</div>
  </div>
</div>

<div id="toast" class="toast" aria-live="polite"></div>

<script>
/* v4: fixed card height + compact layout A + safe DOM */
function lsGet(k,f){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):f;}catch(e){return f;} }
function lsSet(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

const DEFAULT = [
  {name:"火龍", respawn:180},
  {name:"小吉", respawn:480},
  {name:"海露拜", respawn:120},
  {name:"巴陸德", respawn:120}
];

let bosses = lsGet('boss_seq', DEFAULT.slice());
let store = lsGet('boss_times', {});
let audioCtx = null;
let SOUND_ENABLED = true;
let NOTIFY_ENABLED = true;

function safeId(n){ return 'id_' + encodeURIComponent(n); }
function toast(msg,ms=1800){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }

/* WebAudio A ding */
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); else if(audioCtx.state==='suspended') audioCtx.resume().catch(()=>{}); }
function playDing(vol=0.7,when=0){ try{ ensureAudio(); const ctx=audioCtx; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=1200; o.connect(g); g.connect(ctx.destination); const now=ctx.currentTime+when; g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(vol,now+0.005); g.gain.exponentialRampToValueAtTime(0.0001,now+0.6); o.start(now); o.stop(now+0.65);}catch(e){console.warn(e);} }
function playSoon(vol=0.7){ playDing(vol,0.0); playDing(vol*0.9,0.35); playDing(vol*0.8,0.8); }
function playAlert(vol=0.7){ playDing(vol,0.0); playDing(vol,0.25); playDing(vol,0.5); }
function unlockAudio(){ try{ ensureAudio(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); g.gain.value=0; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.02); if(Notification && Notification.requestPermission) Notification.requestPermission(); SOUND_ENABLED=true; NOTIFY_ENABLED=true; toast('通知與音效已啟用'); }catch(e){console.warn(e); toast('無法啟用音效');} }
function disableNotify(){ SOUND_ENABLED=false; NOTIFY_ENABLED=false; toast('已關閉通知/音效'); }
function vibrate(p){ try{ if(navigator.vibrate) navigator.vibrate(p);}catch(e){} }
function playLong(type,vol){ if(!SOUND_ENABLED) return; if(type==='soon') playSoon(vol); else playAlert(vol); vibrate([200,100,200]); }

/* build DOM safely */
const container = document.getElementById('container');

function createCard(b){
  const card = document.createElement('div'); card.className='boss-card'; card.id=safeId(b.name);

  const top = document.createElement('div'); top.className='card-top';
  const infoCol = document.createElement('div'); infoCol.className='info-col';
  const titleLine = document.createElement('div'); titleLine.className='info-top';
  const h2 = document.createElement('h2'); h2.textContent = b.name;
  titleLine.appendChild(h2);
  infoCol.appendChild(titleLine);

  const lines = document.createElement('div'); lines.className='info-lines';
  const last = document.createElement('div'); last.id='last-'+safeId(b.name); last.textContent='上次擊殺：--:--';
  const next = document.createElement('div'); next.id='next-'+safeId(b.name); next.textContent='下一次重生：--:--';
  const cd = document.createElement('div'); cd.id='cd-'+safeId(b.name); cd.textContent='倒數：--:--';
  lines.appendChild(last); lines.appendChild(next); lines.appendChild(cd);
  infoCol.appendChild(lines);

  const rightCol = document.createElement('div'); rightCol.style.display='flex'; rightCol.style.flexDirection='column'; rightCol.style.alignItems='flex-end';
  const del = document.createElement('button'); del.className='smallbtn btn-del'; del.textContent='刪除'; del.addEventListener('click',()=>deleteBoss(b.name));
  rightCol.appendChild(del);

  top.appendChild(infoCol); top.appendChild(rightCol);

  // button row centered
  const btnRow = document.createElement('div'); btnRow.className='btns-row';
  const killBtn = document.createElement('button'); killBtn.className='smallbtn btn-kill'; killBtn.textContent='已擊殺'; killBtn.addEventListener('click',()=>killed(b.name,b.respawn));
  btnRow.appendChild(killBtn);
  ['+1','-1','+5','-5'].forEach(txt=>{
    const btn=document.createElement('button'); btn.className='smallbtn'; btn.textContent=txt;
    btn.addEventListener('click',()=>{ const v = parseInt(txt.replace('+',''),10); adjust(b.name, v); });
    btnRow.appendChild(btn);
  });

  // manual inline row (compact)
  const manual = document.createElement('div'); manual.className='manual-inline';
  const nowBtn = document.createElement('button'); nowBtn.className='smallbtn'; nowBtn.textContent='現在時間';
  const hour = document.createElement('input'); hour.type='number'; hour.className='input-small'; hour.placeholder='時'; hour.min=0; hour.max=23; hour.style.width='64px';
  const minute = document.createElement('input'); minute.type='number'; minute.className='input-small'; minute.placeholder='分'; minute.min=0; minute.max=59; minute.style.width='64px';
  const apply = document.createElement('button'); apply.className='smallbtn'; apply.textContent='套用';
  nowBtn.addEventListener('click', ()=>{
    const d=new Date(); hour.value = String(d.getHours()).padStart(2,'0'); minute.value = String(d.getMinutes()).padStart(2,'0');
  });
  apply.addEventListener('click', ()=>{
    const h = parseInt(hour.value,10); const m = parseInt(minute.value,10);
    if(isNaN(h)||isNaN(m)){ alert('請輸入時和分或按現在時間'); return; }
    const d=new Date(); d.setHours(h,m,0,0);
    store[b.name + '_last'] = d.getTime();
    store[b.name] = d.getTime() + b.respawn*60000;
    store[b.name + '_notified'] = false; store[b.name + '_3min'] = false;
    lsSet('boss_times', store);
    toast('已套用時間');
  });
  manual.appendChild(nowBtn); manual.appendChild(hour); manual.appendChild(minute); manual.appendChild(apply);

  // future line (F1)
  const future = document.createElement('div'); future.className='future'; future.id='future-'+safeId(b.name); future.textContent='未來：--';

  card.appendChild(top);
  card.appendChild(btnRow);
  card.appendChild(manual);
  card.appendChild(future);
  return card;
}

function renderAll(){
  // remove cards except add-box
  document.querySelectorAll('.boss-card').forEach(e=>e.remove());
  bosses.forEach(b=> container.appendChild(createCard(b)));
}

/* CRUD */
function addBoss(){
  const name = document.getElementById('new-name').value.trim();
  const resp = parseInt(document.getElementById('new-respawn').value,10);
  if(!name||!resp){ alert('請輸入名稱與重生時間'); return; }
  if(bosses.find(x=>x.name===name)){ alert('名稱已存在'); return; }
  bosses.push({name:name,respawn:resp});
  lsSet('boss_seq', bosses);
  store[name]=Date.now(); store[name+'_last']=Date.now(); store[name+'_notified']=false; store[name+'_3min']=false;
  lsSet('boss_times', store);
  document.getElementById('new-name').value=''; document.getElementById('new-respawn').value='';
  renderAll();
}

function deleteBoss(name){
  if(!confirm('確定刪除 '+name+' ?')) return;
  bosses = bosses.filter(b=>b.name!==name);
  lsSet('boss_seq', bosses);
  delete store[name]; delete store[name+'_last']; delete store[name+'_notified']; delete store[name+'_3min'];
  lsSet('boss_times', store);
  renderAll();
}

function adjust(name, min){
  if(!store[name]) store[name]=Date.now();
  store[name]+=min*60000;
  store[name+'_notified']=false; store[name+'_3min']=false;
  lsSet('boss_times', store);
}

function killed(name, resp){
  const now=Date.now();
  store[name+'_last']=now;
  store[name]=now+resp*60000;
  store[name+'_notified']=false; store[name+'_3min']=false;
  lsSet('boss_times', store);
}

/* main loop */
function updateLoop(){
  let soon=null; const vol=document.getElementById('volume').value/100;
  bosses.forEach(b=>{
    const last = store[b.name+'_last'] || Date.now();
    let next = store[b.name] || (Date.now() + b.respawn*60000);
    while(next < Date.now()){
      next += b.respawn*60000;
      store[b.name+'_notified']=false; store[b.name+'_3min']=false;
    }
    store[b.name]=next; lsSet('boss_times', store);
    let diff = next - Date.now(); if(diff<0) diff=0;
    if(diff <= 180000 && !store[b.name+'_3min']){
      store[b.name+'_3min']=true; lsSet('boss_times', store);
      if(SOUND_ENABLED) playLong('soon', vol);
      if(NOTIFY_ENABLED && Notification.permission==='granted') new Notification(b.name+' 3 分鐘後刷新！');
    }
    if(diff <= 1000 && !store[b.name+'_notified']){
      store[b.name+'_notified']=true; lsSet('boss_times', store);
      if(SOUND_ENABLED) playLong('alert', vol);
      if(NOTIFY_ENABLED && Notification.permission==='granted') new Notification(b.name+' 已刷新！');
    }
    const lastEl=document.getElementById('last-'+safeId(b.name));
    const nextEl=document.getElementById('next-'+safeId(b.name));
    const cdEl=document.getElementById('cd-'+safeId(b.name));
    const futEl=document.getElementById('future-'+safeId(b.name));
    if(lastEl) lastEl.textContent = '上次擊殺：' + new Date(last).toLocaleTimeString('zh-TW',{hour12:false});
    if(nextEl) nextEl.textContent = '下一次重生：' + new Date(next).toLocaleTimeString('zh-TW',{hour12:false});
    if(cdEl) cdEl.textContent = '倒數：' + Math.floor(diff/60000) + '分 ' + Math.floor((diff%60000)/1000) + '秒';
    if(futEl){
      const arr=[]; for(let i=1;i<=3;i++) arr.push(new Date(next + b.respawn*i*60000).toLocaleTimeString('zh-TW',{hour12:false}));
      futEl.textContent = '未來：' + arr.join('、');
    }
    if(!soon || next < soon.time) soon={name:b.name,time:next,diff};
  });
  if(soon){
    document.getElementById('top-name').textContent = soon.name;
    document.getElementById('top-cd').textContent = Math.floor(soon.diff/60000) + '分 ' + Math.floor((soon.diff%60000)/1000) + '秒';
  }
}

/* init */
function init(){
  bosses.forEach(b=>{ if(!store[b.name]) store[b.name]=Date.now(); if(!store[b.name+'_last']) store[b.name+'_last']=Date.now(); if(store[b.name+'_notified']===undefined) store[b.name+'_notified']=false; if(store[b.name+'_3min']===undefined) store[b.name+'_3min']=false; });
  lsSet('boss_seq', bosses); lsSet('boss_times', store);
  renderAll();
}

document.getElementById('addBtn').addEventListener('click', addBoss);
document.getElementById('unlockBtn').addEventListener('click', unlockAudio);
document.getElementById('muteBtn').addEventListener('click', disableNotify);

init();
setInterval(updateLoop,500);
updateLoop();
</script>
</body>
</html>
